@inherits LayoutComponentBase
@inject ThemeService ThemeService
@inject IJSRuntime JS
@implements IDisposable

<div class="d-flex vh-100">
    @* Sidebar navigation (desktop only) *@
    <nav class="d-none d-md-flex flex-column flex-shrink-0 bg-surface sidebar-nav @(sidebarCollapsed ? "collapsed" : "")"
         style="border-right: 1px solid var(--bs-border-color);">
        <div class="flex-grow-1 overflow-auto">
            <NavMenu />
        </div>
        <div class="p-2 border-top" style="border-color: var(--bs-border-color) !important;">
            <button class="btn btn-sm btn-icon w-100 d-flex align-items-center justify-content-center"
                    title="@(sidebarCollapsed ? "Expand sidebar" : "Collapse sidebar")"
                    @onclick="ToggleSidebar">
                <i class="bi @(sidebarCollapsed ? "bi-chevron-right" : "bi-chevron-left")"></i>
            </button>
        </div>
    </nav>

    <div class="d-flex flex-column flex-grow-1 overflow-hidden">
        @* Main content â€” PageHeader renders as sticky mobile navbar inside here *@
        <main class="flex-grow-1 overflow-auto p-3 main-content">
            @Body
        </main>
    </div>

    @* Mobile offcanvas navigation *@
    <div class="offcanvas offcanvas-start bg-surface" tabindex="-1" id="mobileNav"
         style="border-right: 1px solid var(--bs-border-color);">
        <div class="offcanvas-header border-bottom"
             style="border-color: var(--bs-border-color) !important; padding-top: calc(env(safe-area-inset-top, 0px) + 12px);">
            <h5 class="offcanvas-title text-primary-ss">SentenceStudio</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body p-0">
            <NavMenu />
        </div>
    </div>
</div>

@code {
    private IJSObjectReference? jsModule;
    private bool sidebarCollapsed;

    protected override void OnInitialized()
    {
        sidebarCollapsed = Preferences.Default.Get("SidebarCollapsed", false);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            jsModule = await JS.InvokeAsync<IJSObjectReference>("import", "./js/app.js");
            await jsModule.InvokeVoidAsync("applyTheme", ThemeService.CurrentTheme, ThemeService.CurrentMode);
            ThemeService.ThemeChanged += OnThemeChanged;
        }
    }

    private void ToggleSidebar()
    {
        sidebarCollapsed = !sidebarCollapsed;
        Preferences.Default.Set("SidebarCollapsed", sidebarCollapsed);
    }

    private async void OnThemeChanged(object? sender, ThemeChangedEventArgs e)
    {
        if (jsModule != null)
        {
            await jsModule.InvokeVoidAsync("applyTheme", e.Theme, e.Mode);
        }
    }

    public void Dispose()
    {
        ThemeService.ThemeChanged -= OnThemeChanged;
        jsModule?.DisposeAsync();
    }
}