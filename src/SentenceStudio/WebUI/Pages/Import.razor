@page "/import"
@using SentenceStudio.Shared.Models
@using SentenceStudio.Services

<PageHeader Title="YouTube Import" />

@* Step 1: URL input *@
<div class="card card-ss p-3 mb-4">
    <label class="form-label text-secondary-ss">YouTube URL</label>
    <div class="d-flex gap-2">
        <input type="text" class="form-control form-control-ss"
               @bind="videoUrl" @bind:event="oninput"
               @onkeydown="HandleUrlKeyDown"
               placeholder="https://www.youtube.com/watch?v=..." />
        <button class="btn btn-ss-primary px-4 text-nowrap" @onclick="FetchTranscripts"
                disabled="@(isLoadingTranscripts || string.IsNullOrWhiteSpace(videoUrl))">
            @if (isLoadingTranscripts)
            {
                <span class="spinner-border spinner-border-sm me-1"></span>
            }
            Fetch
        </button>
    </div>
</div>

@* Step 2: Transcript selection and editing *@
@if (availableTranscripts.Any())
{
    <div class="card card-ss p-3 mb-4">
        @* Language selector *@
        @if (availableTranscripts.Count > 1)
        {
            <div class="mb-3">
                <label class="form-label text-secondary-ss">Transcript Language</label>
                <select class="form-select form-control-ss" @onchange="OnTranscriptSelected">
                    @foreach (var track in availableTranscripts)
                    {
                        <option value="@track.LanguageCode"
                                selected="@(track.LanguageCode == selectedTrack?.LanguageCode)">
                            @track.LanguageName @(track.IsAutoGenerated ? "(auto)" : "")
                        </option>
                    }
                </select>
            </div>
        }
        else
        {
            <p class="ss-body2 text-secondary-ss mb-2">
                Language: <strong>@availableTranscripts[0].LanguageName</strong>
                @(availableTranscripts[0].IsAutoGenerated ? " (auto-generated)" : "")
            </p>
        }

        @* Transcript editor *@
        @if (!string.IsNullOrEmpty(transcriptText))
        {
            <div class="mb-3">
                <label class="form-label text-secondary-ss">Transcript</label>
                <textarea class="form-control form-control-ss" rows="12"
                          @bind="transcriptText" @bind:event="oninput"
                          style="font-size: 14px; line-height: 1.6;"></textarea>
            </div>

            <div class="d-flex gap-2">
                <button class="btn btn-ss-secondary" @onclick="PolishTranscript"
                        disabled="@isPolishing">
                    @if (isPolishing)
                    {
                        <span class="spinner-border spinner-border-sm me-1"></span>
                    }
                    <i class="bi bi-stars me-1"></i> Polish with AI
                </button>
                <button class="btn btn-ss-primary flex-grow-1" @onclick="SaveAsResource"
                        disabled="@isSaving">
                    @if (isSaving)
                    {
                        <span class="spinner-border spinner-border-sm me-1"></span>
                    }
                    <i class="bi bi-save me-1"></i> Save as Resource
                </button>
            </div>
        }
        else if (isLoadingTranscript)
        {
            <div class="d-flex justify-content-center p-3">
                <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                <span class="ms-2 text-secondary-ss">Downloading transcript...</span>
            </div>
        }
    </div>
}

@* Success result *@
@if (savedResourceId > 0)
{
    <div class="alert alert-success d-flex align-items-center gap-2">
        <span><i class="bi bi-check-circle-fill me-1"></i> Resource saved successfully!</span>
        <button class="btn btn-sm btn-outline-success" @onclick="ViewSavedResource">View Resource</button>
        <button class="btn btn-sm btn-outline-secondary" @onclick="Reset">Import Another</button>
    </div>
}

@* Error *@
@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}

@code {
    [Inject] private YouTubeImportService ImportSvc { get; set; } = default!;
    [Inject] private TranscriptFormattingService FormattingSvc { get; set; } = default!;
    [Inject] private LearningResourceRepository ResourceRepo { get; set; } = default!;
    [Inject] private UserProfileRepository ProfileRepo { get; set; } = default!;
    [Inject] private NavigationManager NavManager { get; set; } = default!;
    [Inject] private ToastService Toast { get; set; } = default!;
    [Inject] private ILogger<Import> Logger { get; set; } = default!;

    private string videoUrl = "";
    private string transcriptText = "";
    private string errorMessage = "";
    private string preferredLanguage = "ko";
    private bool isLoadingTranscripts;
    private bool isLoadingTranscript;
    private bool isPolishing;
    private bool isSaving;
    private int savedResourceId;

    private List<TranscriptTrack> availableTranscripts = new();
    private TranscriptTrack? selectedTrack;
    private string? videoTitle;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var profile = await ProfileRepo.GetAsync();
            var lang = profile?.TargetLanguage ?? "Korean";
            preferredLanguage = lang.ToLowerInvariant() switch
            {
                "korean" => "ko",
                "japanese" => "ja",
                "chinese" => "zh",
                "spanish" => "es",
                "french" => "fr",
                "german" => "de",
                _ => lang[..Math.Min(2, lang.Length)].ToLowerInvariant()
            };
        }
        catch { }
    }

    private async Task FetchTranscripts()
    {
        if (string.IsNullOrWhiteSpace(videoUrl)) return;

        isLoadingTranscripts = true;
        errorMessage = "";
        availableTranscripts.Clear();
        transcriptText = "";
        savedResourceId = 0;
        StateHasChanged();

        try
        {
            // Get video metadata
            try
            {
                var meta = await ImportSvc.GetVideoMetadataAsync(videoUrl);
                videoTitle = meta?.Title;
            }
            catch { videoTitle = null; }

            var tracks = await ImportSvc.GetAvailableTranscriptsAsync(videoUrl);
            availableTranscripts = tracks ?? new();

            if (!availableTranscripts.Any())
            {
                errorMessage = "No transcripts found for this video.";
                return;
            }

            // Auto-select preferred language
            selectedTrack = availableTranscripts.FirstOrDefault(t =>
                t.LanguageCode.StartsWith(preferredLanguage, StringComparison.OrdinalIgnoreCase))
                ?? availableTranscripts.First();

            await DownloadTranscript();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to fetch transcripts");
            errorMessage = $"Error fetching transcripts: {ex.Message}";
        }
        finally
        {
            isLoadingTranscripts = false;
        }
    }

    private async Task DownloadTranscript()
    {
        if (selectedTrack is null) return;

        isLoadingTranscript = true;
        StateHasChanged();

        try
        {
            var raw = await ImportSvc.DownloadTranscriptTextAsync(selectedTrack);
            transcriptText = FormattingSvc.SmartCleanup(raw, selectedTrack.LanguageCode);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to download transcript");
            errorMessage = "Error downloading transcript.";
        }
        finally
        {
            isLoadingTranscript = false;
        }
    }

    private async Task OnTranscriptSelected(ChangeEventArgs e)
    {
        var code = e.Value?.ToString() ?? "";
        selectedTrack = availableTranscripts.FirstOrDefault(t => t.LanguageCode == code);
        await DownloadTranscript();
    }

    private async Task PolishTranscript()
    {
        if (string.IsNullOrWhiteSpace(transcriptText)) return;

        isPolishing = true;
        StateHasChanged();

        try
        {
            transcriptText = await FormattingSvc.PolishWithAiAsync(transcriptText, selectedTrack?.LanguageCode);
            Toast.ShowSuccess("Transcript polished!");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to polish transcript");
            Toast.ShowError("AI polishing failed. You can still save the current text.");
        }
        finally
        {
            isPolishing = false;
        }
    }

    private async Task SaveAsResource()
    {
        if (string.IsNullOrWhiteSpace(transcriptText)) return;

        isSaving = true;
        errorMessage = "";
        StateHasChanged();

        try
        {
            var resource = new LearningResource
            {
                Title = videoTitle ?? "YouTube Import",
                MediaUrl = videoUrl,
                Transcript = transcriptText,
                MediaType = "Video",
                Language = selectedTrack?.LanguageName ?? ""
            };

            var id = await ResourceRepo.SaveResourceAsync(resource);
            savedResourceId = id;
            Toast.ShowSuccess("Resource saved successfully!");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to save resource");
            errorMessage = $"Error saving resource: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private void ViewSavedResource()
    {
        NavManager.NavigateTo($"/resource-edit?resourceId={savedResourceId}");
    }

    private void Reset()
    {
        videoUrl = "";
        transcriptText = "";
        errorMessage = "";
        availableTranscripts.Clear();
        selectedTrack = null;
        savedResourceId = 0;
        videoTitle = null;
    }

    private async Task HandleUrlKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") await FetchTranscripts();
    }
}