@page "/translation"
@implements IDisposable

<div class="activity-page-wrapper">

<PageHeader Title="Translate" ShowBack="true" OnBack="GoBack" />

<div class="activity-content">
@if (showSessionSummary)
{
    <div class="d-flex flex-column align-items-center justify-content-center" style="min-height: 60vh;">
        <h2 class="ss-title1 mb-4"><i class="bi bi-journal-check me-2"></i>Session Complete!</h2>
        <div class="card card-ss p-4" style="min-width: 340px;">
            <div class="d-flex justify-content-around mb-3">
                <div class="text-center">
                    <div class="ss-title2 text-success">@sessionGradedCount</div>
                    <small class="text-secondary-ss">Graded</small>
                </div>
                <div class="text-center">
                    <div class="ss-title2" style="color: var(--bs-primary);">
                        @(sessionGradedCount > 0 ? (int)(sessionAccuracySum / sessionGradedCount) : 0)%
                    </div>
                    <small class="text-secondary-ss">Avg Accuracy</small>
                </div>
                <div class="text-center">
                    <div class="ss-title2" style="color: var(--bs-info);">
                        @(sessionGradedCount > 0 ? (int)(sessionFluencySum / sessionGradedCount) : 0)%
                    </div>
                    <small class="text-secondary-ss">Avg Fluency</small>
                </div>
            </div>
        </div>
        <button class="btn btn-ss-primary mt-4" @onclick="ContinueAfterSummary">Continue Practice</button>
        <button class="btn btn-ss-secondary mt-2" @onclick="GoBack">Done</button>
    </div>
}
else if (isBusy)
{
    <div class="d-flex flex-column align-items-center justify-content-center" style="min-height: 40vh;">
        <div class="spinner-border text-primary mb-3" role="status"></div>
        <p class="ss-body1 text-secondary-ss">Loading sentences...</p>
    </div>
}
else if (sentences.Any())
{
    @* Sentence display *@
    <div class="mb-4 px-3">
        <p class="ss-display" style="line-height: 1.3;">@currentSentence</p>
    </div>

    @* Feedback *@
    @if (showFeedback)
    {
        <div class="card card-ss p-3 mb-3" style="border-left: 4px solid @GetFeedbackColor();">
            <p class="ss-body1 mb-0">@feedbackMessage</p>
            @if (!string.IsNullOrEmpty(recommendedTranslation))
            {
                <small class="text-secondary-ss mt-1 d-block">
                    <strong>Suggested:</strong> @recommendedTranslation
                </small>
            }
        </div>
    }
}
else
{
    <div class="text-center p-5">
        <p class="ss-body1 text-secondary-ss">No sentences available.</p>
        <button class="btn btn-ss-secondary mt-3" @onclick="GoBack">Go Back</button>
    </div>
}
</div>

@* Blazor input bar — shown on all platforms except macOS where native footer handles input *@
@if (!useNativeFooter && sentences.Any() && !showSessionSummary && !isBusy)
{
<div class="activity-input-bar">
    @if (inputMode == "MultipleChoice" && vocabBlocks.Any())
    {
        <div class="d-flex flex-wrap gap-2 mb-2">
            @foreach (var block in vocabBlocks)
            {
                var b = block;
                <button class="btn btn-sm btn-outline-secondary" @onclick="() => UseVocabBlock(b)">@b</button>
            }
        </div>
    }

    <form @onsubmit="SubmitInput" @onsubmit:preventDefault class="d-flex gap-2 mb-2">
        <input type="text" class="form-control form-control-ss form-control-lg flex-grow-1"
               @bind="userInput"
               placeholder="Translate to @targetLanguage..." />
        <button type="button" class="btn btn-ss-secondary" @onclick="ToggleInputMode">
            @(inputMode == "Text" ? "Blocks" : "Type")
        </button>
        <button type="submit" class="btn btn-ss-primary"
                disabled="@isGrading">
            @if (isGrading)
            {
                <span class="spinner-border spinner-border-sm"></span>
            }
            else
            {
                <span>Grade</span>
            }
        </button>
    </form>

    <div class="d-flex justify-content-between align-items-center">
        <button class="btn btn-sm btn-ss-secondary" @onclick="PreviousSentence" disabled="@(currentIndex <= 0)">
            <i class="bi bi-chevron-left"></i>
        </button>
        <span class="ss-body2 text-secondary-ss">@(currentIndex + 1) / @sentences.Count</span>
        <button class="btn btn-sm btn-ss-secondary" @onclick="NextSentence">
            <i class="bi bi-chevron-right"></i>
        </button>
    </div>
</div>
}

</div>

@code {
    [SupplyParameterFromQuery(Name = "resourceId")]
    public int? ResourceIdParam { get; set; }

    [SupplyParameterFromQuery(Name = "skillId")]
    public int? SkillIdParam { get; set; }

    [Inject] private TranslationService TranslationSvc { get; set; } = default!;
    [Inject] private AiService AiSvc { get; set; } = default!;
    [Inject] private UserActivityRepository ActivityRepo { get; set; } = default!;
    [Inject] private VocabularyProgressService ProgressService { get; set; } = default!;
    [Inject] private NavigationManager NavManager { get; set; } = default!;
    [Inject] private ToastService Toast { get; set; } = default!;
    [Inject] private ILogger<Translation> Logger { get; set; } = default!;
    [Inject] private TranslationBridge Bridge { get; set; } = default!;

    // Native footer only on macOS (Korean IME workaround for WKWebView)
    private bool useNativeFooter = OperatingSystem.IsMacCatalyst();

    private bool isBusy;
    private bool isGrading;
    private bool showFeedback;
    private bool showSessionSummary;
    private string userInput = "";
    private string currentSentence = "";
    private string feedbackMessage = "";
    private string feedbackType = "";
    private string recommendedTranslation = "";
    private string targetLanguage = "Korean";
    private string inputMode = "Text";
    private int currentIndex;
    private int sessionGradedCount;
    private double sessionAccuracySum;
    private double sessionFluencySum;

    private List<Challenge> sentences = new();
    private List<VocabularyWord>? currentVocabulary;
    private List<string> vocabBlocks = new();

    protected override async Task OnInitializedAsync()
    {
        if (useNativeFooter)
        {
            Bridge.OnGradeRequested += OnBridgeGrade;
            Bridge.OnNextRequested += OnBridgeNext;
            Bridge.OnPreviousRequested += OnBridgePrevious;
            Bridge.OnToggleInputModeRequested += OnBridgeToggle;
        }

        await LoadSentences();
    }

    private async Task LoadSentences()
    {
        isBusy = true;
        if (useNativeFooter) Bridge.NotifyContentReady(false);
        try
        {
            var resourceId = ResourceIdParam ?? 0;
            var skillId = SkillIdParam ?? 0;

            var result = await TranslationSvc.GetTranslationSentences(resourceId, 5, skillId);
            if (result?.Any() == true)
            {
                sentences = result;
                SetCurrentSentence();
            }
            else
            {
                Toast.ShowWarning("No sentences returned from the translation service.");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading sentences");
            Toast.ShowError($"Error loading sentences: {ex.Message}");
        }
        finally
        {
            isBusy = false;
            if (useNativeFooter) Bridge.NotifyContentReady(sentences.Any() && !showSessionSummary);
        }
    }

    private void SetCurrentSentence()
    {
        if (currentIndex < 0 || currentIndex >= sentences.Count) return;

        var challenge = sentences[currentIndex];
        currentSentence = challenge.RecommendedTranslation ?? "";
        currentVocabulary = challenge.Vocabulary;
        recommendedTranslation = "";
        userInput = "";
        showFeedback = false;
        feedbackMessage = "";
        inputMode = "Text";

        vocabBlocks = challenge.Vocabulary?
            .Select(v => v.TargetLanguageTerm)
            .Where(t => !string.IsNullOrEmpty(t))
            .OrderBy(_ => Random.Shared.Next())
            .ToList() ?? new();

        // Notify native footer (macOS only)
        if (useNativeFooter)
        {
            Bridge.NotifyProgress(currentIndex + 1, sentences.Count);
            Bridge.NotifyCanGoPrevious(currentIndex > 0);
            Bridge.NotifyVocabBlocks(vocabBlocks);
            Bridge.NotifyInputMode(inputMode);
            Bridge.NotifyClearInput();
        }
    }

    private async Task GradeMe()
    {
        if (string.IsNullOrWhiteSpace(userInput)) return;

        isGrading = true;
        showFeedback = false;
        if (useNativeFooter) Bridge.NotifyGradingState(true);
        StateHasChanged();

        try
        {
            var challenge = sentences[currentIndex];
            var prompt = $"Grade this translation.\n\nOriginal ({targetLanguage}): {currentSentence}\nUser's translation (English): {userInput}\nExpected translation: {challenge.SentenceText}\n\nProvide a JSON response with: fluency_score (0-100), accuracy_score (0-100), fluency_explanation, accuracy_explanation, recommended_translation.";

            var feedback = await AiSvc.SendPrompt<GradeResponse>(prompt);

            recommendedTranslation = feedback.RecommendedTranslation ?? "";
            var accuracy = (int)feedback.Accuracy;
            feedbackType = accuracy >= 80 ? "success" : accuracy >= 50 ? "hint" : "info";
            feedbackMessage = $"Accuracy: {accuracy}% • Fluency: {(int)feedback.Fluency}%";
            if (!string.IsNullOrEmpty(feedback.AccuracyExplanation))
                feedbackMessage += $"\n{feedback.AccuracyExplanation}";

            showFeedback = true;

            sessionGradedCount++;
            sessionAccuracySum += feedback.Accuracy;
            sessionFluencySum += feedback.Fluency;

            await ActivityRepo.SaveAsync(new UserActivity
            {
                Activity = SentenceStudio.Shared.Models.Activity.Translation.ToString(),
                Input = userInput,
                Accuracy = feedback.Accuracy,
                Fluency = feedback.Fluency,
                CreatedAt = DateTime.Now,
                UpdatedAt = DateTime.Now
            });

            Toast.ShowSuccess($"Graded! Accuracy: {accuracy}%");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error grading translation");
            Toast.ShowError("Error grading your translation. Please try again.");
        }
        finally
        {
            isGrading = false;
            if (useNativeFooter) Bridge.NotifyGradingState(false);
        }
    }

    private void NextSentence()
    {
        if (currentIndex < sentences.Count - 1)
        {
            currentIndex++;
            SetCurrentSentence();
            StateHasChanged();
        }
        else
        {
            showSessionSummary = true;
            if (useNativeFooter) Bridge.NotifyContentReady(false);
            StateHasChanged();
        }
    }

    private void PreviousSentence()
    {
        if (currentIndex > 0)
        {
            currentIndex--;
            SetCurrentSentence();
            StateHasChanged();
        }
    }

    private async Task ContinueAfterSummary()
    {
        showSessionSummary = false;
        sessionGradedCount = 0;
        sessionAccuracySum = 0;
        sessionFluencySum = 0;
        currentIndex = 0;
        sentences.Clear();
        await LoadSentences();
    }

    private void ToggleInputMode()
    {
        inputMode = inputMode == "Text" ? "MultipleChoice" : "Text";
        if (useNativeFooter)
        {
            Bridge.NotifyInputMode(inputMode);
            Bridge.NotifyVocabBlocks(vocabBlocks);
        }
    }

    // ── Blazor input bar handlers (non-macOS platforms) ──

    private async Task SubmitInput()
    {
        await GradeMe();
    }

    private void UseVocabBlock(string word)
    {
        userInput = string.IsNullOrEmpty(userInput) ? word : $"{userInput} {word}";
    }

    // ── Bridge event handlers (called from native footer, macOS only) ──

    private async void OnBridgeGrade(string input)
    {
        userInput = input;
        await InvokeAsync(async () =>
        {
            await GradeMe();
            StateHasChanged();
        });
    }

    private async void OnBridgeNext()
    {
        await InvokeAsync(() =>
        {
            NextSentence();
        });
    }

    private async void OnBridgePrevious()
    {
        await InvokeAsync(() =>
        {
            PreviousSentence();
        });
    }

    private async void OnBridgeToggle()
    {
        await InvokeAsync(() =>
        {
            ToggleInputMode();
            StateHasChanged();
        });
    }

    private string GetFeedbackColor() => feedbackType switch
    {
        "success" => "var(--bs-success)",
        "achievement" => "var(--bs-warning)",
        "hint" => "var(--bs-info)",
        _ => "var(--bs-secondary)"
    };

    private void GoBack() => NavManager.NavigateTo("/");

    public void Dispose()
    {
        if (useNativeFooter)
        {
            Bridge.NotifyContentReady(false);
            Bridge.OnGradeRequested -= OnBridgeGrade;
            Bridge.OnNextRequested -= OnBridgeNext;
            Bridge.OnPreviousRequested -= OnBridgePrevious;
            Bridge.OnToggleInputModeRequested -= OnBridgeToggle;
        }
    }
}
