@page "/conversation"
@using SentenceStudio.Shared.Models
@using SentenceStudio.Services
@using SentenceStudio.Services.Speech
@using SentenceStudio.Services.Timer
@using Plugin.Maui.Audio
@implements IDisposable

<div class="d-flex flex-column h-100">
<PageHeader Title="Conversation" ShowBack="true" OnBack="GoBack">
    <ToolbarActions>
        <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary d-flex align-items-center gap-1"
                    type="button" data-bs-toggle="dropdown" aria-expanded="false"
                    title="Change language">
                <i class="bi bi-translate"></i>
                <span class="d-none d-md-inline ss-caption1">@targetLanguage</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                @foreach (var lang in SentenceStudio.Common.Constants.Languages)
                {
                    var l = lang;
                    <li>
                        <button class="dropdown-item @(l == targetLanguage ? "active" : "")"
                                @onclick="() => ChangeLanguage(l)">
                            @l
                        </button>
                    </li>
                }
            </ul>
        </div>
    </ToolbarActions>
</PageHeader>
@if (isBusy && !chunks.Any())
{
    <div class="d-flex flex-column align-items-center justify-content-center flex-grow-1">
        <div class="spinner-border text-primary mb-3" role="status"></div>
        <p class="ss-body1 text-secondary-ss">Starting conversation...</p>
    </div>
}
else
{
    @* Activity Timer *@
    @if (fromPlan)
    {
        <div class="flex-shrink-0">
            <ActivityTimer IsActive="true" TargetMinutes="targetMinutes" />
        </div>
    }

    @* Scenario selector *@
    @if (scenarios.Any())
    {
        <div class="d-flex align-items-center gap-2 mb-3 flex-shrink-0">
            <label class="ss-caption1 text-secondary-ss mb-0">Scenario:</label>
            <select class="form-select form-select-sm" style="width: auto;" @onchange="OnScenarioChanged">
                @foreach (var s in scenarios)
                {
                    <option value="@s.Id" selected="@(s.Id == activeScenario?.Id)">@s.DisplayName</option>
                }
            </select>
        </div>
    }

    @* Chat messages — scrollable, fills remaining space *@
    <div class="d-flex flex-column gap-2 flex-grow-1 overflow-auto pb-2" @ref="chatContainer">
        @foreach (var chunk in chunks)
        {
            var isUser = chunk.Role == ConversationRole.User;
            <div class="d-flex @(isUser ? "justify-content-end" : "justify-content-start")">
                <div class="card p-3 @(isUser ? "bg-primary bg-opacity-10" : "card-ss")"
                     style="max-width: 75%; border-radius: 16px; @(isUser ? "border-bottom-right-radius: 4px;" : "border-bottom-left-radius: 4px;")">
                    <p class="ss-body1 mb-0">@chunk.Text</p>

                    @if (chunk.GrammarCorrections?.Any() == true)
                    {
                        <div class="mt-2 pt-2 border-top border-secondary-subtle">
                            @foreach (var correction in chunk.GrammarCorrections)
                            {
                                <div class="mb-1">
                                    <small>
                                        <span class="text-danger text-decoration-line-through">@correction.Original</span>
                                        → <span class="text-success fw-bold">@correction.Corrected</span>
                                    </small>
                                    @if (!string.IsNullOrEmpty(correction.Explanation))
                                    {
                                        <br /><small class="text-secondary-ss">@correction.Explanation</small>
                                    }
                                </div>
                            }
                        </div>
                    }

                    @if (chunk.Comprehension > 0)
                    {
                        <div class="mt-1">
                            <small class="text-secondary-ss">Comprehension: @((int)chunk.Comprehension)%</small>
                        </div>
                    }

                    @if (!isUser)
                    {
                        <button class="btn btn-sm btn-link p-0 mt-1 text-start" @onclick="() => PlayChunkAudio(chunk)">
                            <i class="bi bi-volume-up me-1"></i> Listen
                        </button>
                    }
                </div>
            </div>
        }

        @if (isWaitingForReply)
        {
            <div class="d-flex justify-content-start">
                <div class="card card-ss p-3" style="border-radius: 16px; border-bottom-left-radius: 4px;">
                    <div class="d-flex gap-1">
                        <div class="spinner-grow spinner-grow-sm text-secondary" role="status"></div>
                        <div class="spinner-grow spinner-grow-sm text-secondary" role="status" style="animation-delay: 0.15s;"></div>
                        <div class="spinner-grow spinner-grow-sm text-secondary" role="status" style="animation-delay: 0.3s;"></div>
                    </div>
                </div>
            </div>
        }
    </div>

    @* Audio player for TTS *@
    @if (isPlayingAudio)
    {
        <div class="card card-ss p-2 mb-2 flex-shrink-0">
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-sm btn-ss-secondary" @onclick="StopAudio"><i class="bi bi-stop-fill me-1"></i> Stop</button>
                <span class="ss-caption1 text-secondary-ss">Playing audio...</span>
            </div>
        </div>
    }

    @* Input area — anchored to bottom *@
    <div class="card card-ss p-3 flex-shrink-0 mt-auto">
        @if (showQuickPhrases)
        {
            <div class="d-flex flex-wrap gap-2 mb-2">
                @foreach (var phrase in quickPhrases)
                {
                    var p = phrase;
                    <button class="btn btn-sm btn-outline-secondary" @onclick="() => UseQuickPhrase(p)">@p</button>
                }
            </div>
        }
        <div class="d-flex gap-2">
            <input type="text" class="form-control form-control-ss"
                   value="@userInput"
                   @oninput="OnInput"
                   @onkeydown="HandleKeyDown"
                   placeholder="Type your message..."
                   disabled="@isWaitingForReply" />
            <button class="btn btn-ss-secondary btn-sm px-2" @onclick="ToggleQuickPhrases"
                    title="Quick phrases" disabled="@isWaitingForReply">
                <i class="bi bi-chat-quote"></i>
            </button>
            <button class="btn btn-ss-primary px-4 text-nowrap" @onclick="SendMessage"
                    disabled="@(isWaitingForReply || string.IsNullOrWhiteSpace(userInput))">
                Send
            </button>
        </div>
    </div>
}
</div>

@code {
    [SupplyParameterFromQuery(Name = "scenarioId")]
    public int? ScenarioIdParam { get; set; }

    [SupplyParameterFromQuery(Name = "fromPlan")]
    public bool FromPlanParam { get; set; }

    [SupplyParameterFromQuery(Name = "targetMinutes")]
    public int? TargetMinutesParam { get; set; }

    [Inject] private ConversationService ConversationSvc { get; set; } = default!;
    [Inject] private IScenarioService ScenarioSvc { get; set; } = default!;
    [Inject] private ElevenLabsSpeechService SpeechService { get; set; } = default!;
    [Inject] private SpeechVoicePreferences VoicePrefs { get; set; } = default!;
    [Inject] private UserProfileRepository ProfileRepo { get; set; } = default!;
    [Inject] private SentenceStudio.Abstractions.IFileSystemService FileSystemService { get; set; } = default!;
    [Inject] private IAudioManager AudioMgr { get; set; } = default!;
    [Inject] private NavigationManager NavManager { get; set; } = default!;
    [Inject] private ToastService Toast { get; set; } = default!;
    [Inject] private ILogger<Conversation> Logger { get; set; } = default!;

    private bool isBusy;
    private bool isWaitingForReply;
    private bool isPlayingAudio;
    private bool showQuickPhrases;
    private bool fromPlan;
    private int targetMinutes;
    private string userInput = "";
    private string targetLanguage = "Korean";
    private string voiceId = "";

    private List<ConversationChunk> chunks = new();
    private List<ConversationScenario> scenarios = new();
    private ConversationScenario? activeScenario;
    private IAudioPlayer? audioPlayer;
    private ElementReference chatContainer;

    // Helper phrases in Korean (target language)
    private static readonly string[] quickPhrases = new[]
    {
        "이게 뭐예요?",         // What is this?
        "더 자세히 설명해 주세요.", // Can you explain in more detail?
        "이해해요.",             // I understand.
        "다시 말해 주세요.",      // Please say that again.
        "조금만 할 수 있어요.",   // I only speak a little.
        "도와줘서 감사합니다.",    // Thank you for helping.
        "천천히 말해 주세요.",    // Please speak slower.
        "그게 무슨 뜻이에요?",   // What does that mean?
    };

    private void ToggleQuickPhrases() => showQuickPhrases = !showQuickPhrases;

    private void UseQuickPhrase(string phrase)
    {
        userInput = phrase;
        showQuickPhrases = false;
    }

    protected override async Task OnInitializedAsync()
    {
        fromPlan = FromPlanParam;
        targetMinutes = TargetMinutesParam ?? 15;

        try
        {
            var profile = await ProfileRepo.GetAsync();
            targetLanguage = profile?.TargetLanguage ?? "Korean";
            voiceId = VoicePrefs.GetVoiceForLanguage(targetLanguage);

            scenarios = await ScenarioSvc.GetAllScenariosAsync() ?? new();

            if (ScenarioIdParam is not null and > 0)
                activeScenario = scenarios.FirstOrDefault(s => s.Id == ScenarioIdParam.Value);

            activeScenario ??= scenarios.FirstOrDefault();

            await StartConversation();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to initialize conversation");
            Toast.ShowError("Could not start conversation.");
        }
    }

    private async Task ChangeLanguage(string language)
    {
        if (language == targetLanguage) return;
        targetLanguage = language;
        voiceId = VoicePrefs.GetVoiceForLanguage(targetLanguage);
        await StartConversation();
    }

    private async Task StartConversation()
    {
        isBusy = true;
        try
        {
            chunks.Clear();
            var opening = await ConversationSvc.StartConversation(activeScenario, targetLanguage);
            if (!string.IsNullOrEmpty(opening))
            {
                chunks.Add(new ConversationChunk
                {
                    Text = opening,
                    Author = activeScenario?.PersonaName ?? "AI",
                    Role = ConversationRole.Assistant,
                    SentTime = DateTime.Now
                });
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to start conversation");
            Toast.ShowError("Error starting conversation.");
        }
        finally
        {
            isBusy = false;
        }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(userInput) || isWaitingForReply) return;

        var message = userInput.Trim();
        userInput = "";

        var userChunk = new ConversationChunk
        {
            Text = message,
            Author = "Me",
            Role = ConversationRole.User,
            SentTime = DateTime.Now
        };
        chunks.Add(userChunk);
        isWaitingForReply = true;
        StateHasChanged();

        try
        {
            var reply = await ConversationSvc.ContinueConversation(chunks, activeScenario, targetLanguage);
            if (reply is not null)
            {
                // Apply grammar corrections to user chunk
                if (reply.GrammarCorrections?.Any() == true)
                {
                    userChunk.GrammarCorrections = reply.GrammarCorrections;
                }
                userChunk.Comprehension = reply.Comprehension;

                var aiChunk = new ConversationChunk
                {
                    Text = reply.Message ?? "",
                    Author = activeScenario?.PersonaName ?? "AI",
                    Role = ConversationRole.Assistant,
                    SentTime = DateTime.Now
                };
                chunks.Add(aiChunk);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to get reply");
            Toast.ShowError("Error getting response. Please try again.");
        }
        finally
        {
            isWaitingForReply = false;
        }
    }

    private async Task PlayChunkAudio(ConversationChunk chunk)
    {
        if (string.IsNullOrEmpty(chunk.Text)) return;
        StopAudio();

        try
        {
            isPlayingAudio = true;
            StateHasChanged();

            var vid = !string.IsNullOrEmpty(voiceId) ? voiceId : "echo";
            var stream = await SpeechService.TextToSpeechAsync(chunk.Text, vid);

            // Save to temp file for playback
            var cacheDir = Path.Combine(FileSystemService.AppDataDirectory, "Cache");
            Directory.CreateDirectory(cacheDir);
            var tempPath = Path.Combine(cacheDir, $"conv_{Guid.NewGuid():N}.mp3");
            using (var fs = File.Create(tempPath))
            {
                await stream.CopyToAsync(fs);
            }

            using var playStream = File.OpenRead(tempPath);
            audioPlayer = AudioMgr.CreatePlayer(playStream);
            audioPlayer.PlaybackEnded += (s, e) =>
            {
                isPlayingAudio = false;
                InvokeAsync(StateHasChanged);
            };
            audioPlayer.Play();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to play audio");
            isPlayingAudio = false;
            Toast.ShowError("Audio playback failed.");
        }
    }

    private async Task OnScenarioChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var id))
        {
            activeScenario = scenarios.FirstOrDefault(s => s.Id == id);
            await StartConversation();
        }
    }

    private void OnInput(ChangeEventArgs e)
    {
        userInput = e.Value?.ToString() ?? "";
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") await SendMessage();
    }

    private void StopAudio()
    {
        audioPlayer?.Stop();
        audioPlayer?.Dispose();
        audioPlayer = null;
        isPlayingAudio = false;
    }

    public void Dispose()
    {
        StopAudio();
    }

    private void GoBack() => NavManager.NavigateTo("/");
}
