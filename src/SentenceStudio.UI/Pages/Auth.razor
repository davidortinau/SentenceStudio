@page "/auth"

<PageHeader Title="Welcome" />

<div class="container" style="max-width: 600px;">
    <div class="card card-ss p-4 mt-4">
        <h1 class="ss-title1 mb-2">Welcome to SentenceStudio</h1>
        <p class="ss-body2 text-secondary-ss mb-4">
            Select a user to continue, or register to create a new account.
        </p>

        @if (_profiles.Count > 0)
        {
            <h2 class="ss-title3 mb-2">Choose a user</h2>
            <div class="d-grid gap-2 mb-3">
                @foreach (var profile in _profiles)
                {
                    var p = profile;
                    <button class="btn btn-ss-secondary btn-lg text-start d-flex align-items-center gap-2"
                            @onclick="() => LoginAsAsync(p)">
                        <i class="bi bi-person-circle"></i>
                        <div>
                            <strong>@p.Name</strong>
                            <br />
                            <small class="text-secondary-ss">@p.NativeLanguage â†’ @p.TargetLanguage</small>
                        </div>
                    </button>
                }
            </div>
            <hr class="my-3" />
        }

        <div class="d-grid gap-2">
            <button class="btn btn-ss-primary btn-lg" @onclick="RegisterAsync">
                <i class="bi bi-plus-circle me-2"></i>Create New User
            </button>
        </div>
    </div>
</div>

@code {
    public const string AuthenticatedPreferenceKey = "app_is_authenticated";
    public const string ActiveProfileIdKey = "active_profile_id";

    [Inject] private SentenceStudio.Abstractions.IPreferencesService Preferences { get; set; } = default!;
    [Inject] private UserProfileRepository ProfileRepo { get; set; } = default!;
    [Inject] private IAppState AppState { get; set; } = default!;
    [Inject] private NavigationManager NavManager { get; set; } = default!;

    private List<UserProfile> _profiles = new();

    protected override async Task OnInitializedAsync()
    {
        _profiles = await ProfileRepo.ListAsync() ?? new();
    }

    private void LoginAsAsync(UserProfile profile)
    {
        Preferences.Set(AuthenticatedPreferenceKey, true);
        Preferences.Set(ActiveProfileIdKey, profile.Id);
        Preferences.Set("is_onboarded", true);
        AppState.CurrentUserProfile = profile;
        NavManager.NavigateTo("/", forceLoad: true);
    }

    private void RegisterAsync()
    {
        Preferences.Set(AuthenticatedPreferenceKey, true);
        Preferences.Set("is_onboarded", false);
        NavManager.NavigateTo("/onboarding");
    }
}
