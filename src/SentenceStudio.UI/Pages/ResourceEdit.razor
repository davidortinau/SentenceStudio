@page "/resources/edit/{Id:int}"
@using SentenceStudio.Services

@if (isLoading)
{
    <div class="d-flex justify-content-center p-5">
        <div class="spinner-border text-primary" role="status"></div>
    </div>
}
else
{
    <PageHeader Title="@(resource.Title ?? "Resource")" ShowBack="true" OnBack="GoBack">
        <PrimaryActions>
            <button class="btn btn-ss-primary" @onclick="SaveResource" disabled="@isSaving">
                @if (isSaving) { <span class="spinner-border spinner-border-sm me-1"></span> }
                Save
            </button>
        </PrimaryActions>
        <SecondaryActions>
            <li><button class="dropdown-item" @onclick="SaveResource" disabled="@isSaving"><i class="bi bi-check-lg me-2"></i>Save</button></li>
            <li><hr class="dropdown-divider" /></li>
            <li><button class="dropdown-item text-danger" @onclick="DeleteResource"><i class="bi bi-trash me-2"></i>Delete</button></li>
        </SecondaryActions>
    </PageHeader>

    @if (resource.IsSmartResource)
    {
        <div class="alert alert-info d-flex align-items-center gap-2 mb-3">
            <i class="bi bi-robot"></i>
            <strong>Smart Resource</strong>
            <span class="text-secondary-ss">â€” Auto-updated by the system</span>
        </div>
    }

    <div class="card card-ss p-4 mb-3">
        <h5 class="ss-title3 mb-3">Basic Information</h5>

        <div class="mb-3">
            <label class="form-label ss-body2 text-secondary-ss">Title</label>
            <input type="text" class="form-control form-control-ss" @bind="resource.Title" />
        </div>

        <div class="mb-3">
            <label class="form-label ss-body2 text-secondary-ss">Description</label>
            <textarea class="form-control form-control-ss" @bind="resource.Description" rows="3"></textarea>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label ss-body2 text-secondary-ss">Media Type</label>
                <select class="form-select form-control-ss" @bind="resource.MediaType">
                    @foreach (var type in mediaTypes)
                    {
                        <option value="@type">@type</option>
                    }
                </select>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label ss-body2 text-secondary-ss">Language</label>
                <select class="form-select form-control-ss" @bind="resource.Language">
                    @foreach (var lang in languages)
                    {
                        <option value="@lang">@lang</option>
                    }
                </select>
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label ss-body2 text-secondary-ss">Media URL</label>
            <input type="url" class="form-control form-control-ss" @bind="resource.MediaUrl" />
        </div>

        <div class="mb-3">
            <label class="form-label ss-body2 text-secondary-ss">Tags (comma separated)</label>
            <input type="text" class="form-control form-control-ss" @bind="resource.Tags" />
        </div>

        <div class="row g-2 mt-2">
            <div class="col-4 col-md-2"><strong class="ss-body2 text-secondary-ss">Created</strong></div>
            <div class="col-8 col-md-4 ss-body2">@resource.CreatedAt.ToString("g")</div>

            <div class="col-4 col-md-2"><strong class="ss-body2 text-secondary-ss">Updated</strong></div>
            <div class="col-8 col-md-4 ss-body2">@resource.UpdatedAt.ToString("g")</div>
        </div>
    </div>

    <div class="card card-ss p-4 mb-3">
        <h5 class="ss-title3 mb-3">Transcript</h5>
        <textarea class="form-control form-control-ss" @bind="resource.Transcript" rows="6"></textarea>
    </div>

    <div class="card card-ss p-4 mb-3">
        <h5 class="ss-title3 mb-3">Translation</h5>
        <textarea class="form-control form-control-ss" @bind="resource.Translation" rows="6"></textarea>
    </div>

    @* Vocabulary *@
    <div class="card card-ss p-4 mb-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="ss-title3 mb-0">Vocabulary (@(resource.Vocabulary?.Count ?? 0) words)</h5>
            @if (!string.IsNullOrWhiteSpace(resource.Transcript))
            {
                <button class="btn btn-ss-secondary btn-sm" @onclick="GenerateVocabulary"
                        disabled="@isGeneratingVocabulary">
                    @if (isGeneratingVocabulary)
                    {
                        <span class="spinner-border spinner-border-sm me-1"></span>
                        <span>Generating...</span>
                    }
                    else
                    {
                        <i class="bi bi-stars me-1"></i>
                        <span>Generate from Transcript</span>
                    }
                </button>
            }
        </div>

        <div class="mb-3">
            <label class="form-label ss-body2 text-secondary-ss">Import vocabulary (one pair per line)</label>
            <textarea class="form-control form-control-ss" @bind="vocabList" rows="4"
                      placeholder="target, native"></textarea>
        </div>

        <div class="d-flex align-items-center gap-3 mb-3">
            <div class="form-check">
                <input class="form-check-input" type="radio" name="editDelimiter" id="editDelimComma"
                       checked="@(delimiter == "comma")" @onchange="SetDelimiterComma" />
                <label class="form-check-label ss-body2" for="editDelimComma">Comma</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="editDelimiter" id="editDelimTab"
                       checked="@(delimiter == "tab")" @onchange="SetDelimiterTab" />
                <label class="form-check-label ss-body2" for="editDelimTab">Tab</label>
            </div>
            <button class="btn btn-ss-secondary btn-sm ms-auto" @onclick="ImportVocabulary"
                    disabled="@string.IsNullOrWhiteSpace(vocabList)">
                Import
            </button>
        </div>

        @if (resource.Vocabulary?.Count > 0)
        {
            <div class="list-group list-group-flush">
                @foreach (var word in resource.Vocabulary)
                {
                    <div class="list-group-item d-flex justify-content-between align-items-center bg-transparent border-secondary px-0">
                        <div>
                            <strong class="ss-body1">@word.TargetLanguageTerm</strong>
                            <span class="text-secondary-ss ms-2">@word.NativeLanguageTerm</span>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <p class="text-secondary-ss ss-body2 mb-0">No vocabulary words yet.</p>
        }
    </div>
}

@code {
    [Parameter] public int Id { get; set; }

    [Inject] private LearningResourceRepository ResourceRepo { get; set; } = default!;
    [Inject] private UserProfileRepository ProfileRepo { get; set; } = default!;
    [Inject] private AiService AiSvc { get; set; } = default!;
    [Inject] private NavigationManager NavManager { get; set; } = default!;
    [Inject] private ToastService Toast { get; set; } = default!;
    [Inject] private IJSRuntime JS { get; set; } = default!;
    [Inject] private ILogger<ResourceEdit> Logger { get; set; } = default!;

    private LearningResource resource = new();
    private bool isLoading = true;
    private bool isSaving;
    private bool isGeneratingVocabulary;
    private string vocabList = "";
    private string delimiter = "comma";
    private IJSObjectReference? jsModule;

    private void SetDelimiterComma() => delimiter = "comma";
    private void SetDelimiterTab() => delimiter = "tab";

    private readonly string[] mediaTypes = SentenceStudio.Common.Constants.MediaTypes;
    private readonly string[] languages = SentenceStudio.Common.Constants.Languages;

    protected override async Task OnInitializedAsync()
    {
        await LoadResource();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
            jsModule = await JS.InvokeAsync<IJSObjectReference>("import", "./js/app.js");
    }

    private async Task LoadResource()
    {
        isLoading = true;
        try
        {
            resource = await ResourceRepo.GetResourceAsync(Id);
        }
        catch (Exception ex)
        {
            Toast.ShowError($"Failed to load resource: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void GoBack() => NavManager.NavigateTo("/resources");

    private async Task SaveResource()
    {
        if (string.IsNullOrWhiteSpace(resource.Title))
        {
            Toast.ShowError("Title is required.");
            return;
        }

        if (string.IsNullOrWhiteSpace(resource.MediaType))
            resource.MediaType = "Other";
        if (string.IsNullOrWhiteSpace(resource.Language))
            resource.Language = "Other";

        isSaving = true;
        try
        {
            resource.UpdatedAt = DateTime.UtcNow;
            await ResourceRepo.SaveResourceAsync(resource);
            Toast.ShowSuccess("Resource saved.");
        }
        catch (Exception ex)
        {
            Toast.ShowError($"Failed to save: {ex.Message}");
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task DeleteResource()
    {
        if (jsModule == null) return;
        var confirmed = await jsModule.InvokeAsync<bool>("showConfirm",
            "Are you sure you want to delete this resource? This cannot be undone.");

        if (confirmed)
        {
            try
            {
                await ResourceRepo.DeleteResourceAsync(resource);
                Toast.ShowSuccess("Resource deleted.");
                NavManager.NavigateTo("/resources");
            }
            catch (Exception ex)
            {
                Toast.ShowError($"Failed to delete: {ex.Message}");
            }
        }
    }

    private void ImportVocabulary()
    {
        if (string.IsNullOrWhiteSpace(vocabList))
            return;

        try
        {
            var newWords = VocabularyWord.ParseVocabularyWords(vocabList, delimiter);
            resource.Vocabulary ??= new List<VocabularyWord>();

            int added = 0;
            foreach (var word in newWords)
            {
                bool isDuplicate = resource.Vocabulary.Any(existing =>
                    existing.TargetLanguageTerm?.Trim().Equals(word.TargetLanguageTerm?.Trim(), StringComparison.OrdinalIgnoreCase) == true);

                if (!isDuplicate)
                {
                    word.CreatedAt = DateTime.UtcNow;
                    word.UpdatedAt = DateTime.UtcNow;
                    resource.Vocabulary.Add(word);
                    added++;
                }
            }

            vocabList = "";
            Toast.ShowSuccess($"Imported {added} vocabulary words.");
        }
        catch (Exception ex)
        {
            Toast.ShowError($"Import failed: {ex.Message}");
        }
    }

    private async Task GenerateVocabulary()
    {
        if (string.IsNullOrWhiteSpace(resource.Transcript))
        {
            Toast.ShowError("No transcript available to generate vocabulary from.");
            return;
        }

        isGeneratingVocabulary = true;
        StateHasChanged();

        try
        {
            var profile = await ProfileRepo.GetAsync();
            var targetLanguage = !string.IsNullOrWhiteSpace(resource.Language)
                ? resource.Language
                : profile?.TargetLanguage ?? "Korean";
            var nativeLanguage = profile?.NativeLanguage ?? "English";

            string prompt = $@"
You are a language learning assistant. Analyze this {targetLanguage} transcript and extract ALL vocabulary words that would be useful for a learner.

CRITICAL: Pay close attention to which field is which:
- TargetLanguageTerm = The word in {targetLanguage} (the language being learned, NOT {nativeLanguage})
- NativeLanguageTerm = The {nativeLanguage} translation

For EACH word or phrase you find in the transcript, provide:
1. TargetLanguageTerm: The word in {targetLanguage} - use dictionary/base form when appropriate
2. NativeLanguageTerm: The {nativeLanguage} translation

Include:
- Nouns, verbs, adjectives, adverbs
- Common expressions and phrases
- Grammar patterns if useful
- ALL words that appear in the transcript, even if they seem basic

IMPORTANT:
- TargetLanguageTerm MUST be in {targetLanguage}
- NativeLanguageTerm MUST be in {nativeLanguage}
- Do NOT swap these fields

Format your response as a valid JSON array of objects with TargetLanguageTerm and NativeLanguageTerm properties.

Transcript:
{resource.Transcript}
";

            Logger.LogDebug("Generating vocabulary for {Language} transcript ({Length} chars)", targetLanguage, resource.Transcript.Length);

            var vocabulary = await AiSvc.SendPrompt<List<VocabularyWord>>(prompt);

            if (vocabulary == null || !vocabulary.Any())
            {
                Toast.ShowError("AI did not generate any vocabulary. Try again.");
                return;
            }

            Logger.LogDebug("AI returned {Count} vocabulary words", vocabulary.Count);

            resource.Vocabulary ??= new List<VocabularyWord>();
            int newWordsCreated = 0;
            int existingWordsLinked = 0;
            int duplicatesSkipped = 0;

            foreach (var wordData in vocabulary)
            {
                if (string.IsNullOrWhiteSpace(wordData.TargetLanguageTerm))
                    continue;

                var targetTerm = wordData.TargetLanguageTerm.Trim();
                var nativeTerm = wordData.NativeLanguageTerm?.Trim() ?? "";

                // Detect swapped terms
                bool targetIsEnglish = IsLikelyEnglish(targetTerm);
                bool nativeIsEnglish = IsLikelyEnglish(nativeTerm);

                if (targetIsEnglish && !nativeIsEnglish)
                    (targetTerm, nativeTerm) = (nativeTerm, targetTerm);
                else if (targetIsEnglish && nativeIsEnglish)
                    continue;

                // Skip if already in resource
                if (resource.Vocabulary.Any(w =>
                    w.TargetLanguageTerm?.Trim().Equals(targetTerm, StringComparison.OrdinalIgnoreCase) == true))
                {
                    duplicatesSkipped++;
                    continue;
                }

                try
                {
                    var word = await GetOrCreateWordAsync(targetTerm, nativeTerm);
                    resource.Vocabulary.Add(word);

                    if ((DateTime.UtcNow - word.CreatedAt).TotalSeconds < 5)
                        newWordsCreated++;
                    else
                        existingWordsLinked++;
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Error processing word '{Term}'", targetTerm);
                }
            }

            // Save resource with new vocabulary associations
            await ResourceRepo.SaveResourceAsync(resource);

            var msg = $"Generated {vocabulary.Count} words: {newWordsCreated} new, {existingWordsLinked} linked";
            if (duplicatesSkipped > 0)
                msg += $", {duplicatesSkipped} skipped (already in resource)";
            Toast.ShowSuccess(msg);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "GenerateVocabulary error");
            Toast.ShowError($"Vocabulary generation failed: {ex.Message}");
        }
        finally
        {
            isGeneratingVocabulary = false;
        }
    }

    private async Task<VocabularyWord> GetOrCreateWordAsync(string targetTerm, string nativeTerm)
    {
        var existing = await ResourceRepo.GetWordByTargetTermAsync(targetTerm);
        if (existing != null)
            return existing;

        var word = new VocabularyWord
        {
            TargetLanguageTerm = targetTerm,
            NativeLanguageTerm = nativeTerm,
            CreatedAt = DateTime.UtcNow,
            UpdatedAt = DateTime.UtcNow
        };

        var result = await ResourceRepo.SaveWordAsync(word);
        if (result <= 0)
            throw new Exception($"Failed to save word: {targetTerm}");

        return word;
    }

    private static bool IsLikelyEnglish(string text)
    {
        if (string.IsNullOrWhiteSpace(text)) return false;
        int latinCount = 0, totalLetters = 0;
        foreach (char c in text)
        {
            if (char.IsLetter(c))
            {
                totalLetters++;
                if ((c >= 'A' && c <= 'Z') || (c >= 'a' && c <= 'z'))
                    latinCount++;
            }
        }
        return totalLetters > 0 && (latinCount / (double)totalLetters) > 0.8;
    }
}
