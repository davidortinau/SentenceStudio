@page "/reading"
@using SentenceStudio.Shared.Models
@using SentenceStudio.Models
@using SentenceStudio.Services
@using SentenceStudio.Services.Speech
@using SentenceStudio.Services.Timer
@using Plugin.Maui.Audio
@implements IDisposable

<div class="reading-page">
    @* ── Fixed header ── *@
    <div class="reading-page__header">
        <PageHeader Title="Reading" ShowBack="true" OnBack="GoBack" />
        @if (resource is not null && sentences.Any())
        {
            <div class="d-flex align-items-center px-3 pb-2">
                <h2 class="ss-title2 mb-0">@resource.Title</h2>
            </div>
        }
    </div>

    @* ── Scrollable content ── *@
    <div class="reading-page__content">
        @if (isBusy)
        {
            <div class="d-flex flex-column align-items-center justify-content-center" style="min-height: 40vh;">
                <div class="spinner-border text-primary mb-3" role="status"></div>
                <p class="ss-body1 text-secondary-ss">Loading passage...</p>
            </div>
        }
        else if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="text-center p-5">
                <i class="bi bi-exclamation-triangle fs-1 text-warning-ss d-block mb-3"></i>
                <p class="ss-body1 text-secondary-ss">@errorMessage</p>
                <button class="btn btn-ss-secondary mt-3" @onclick="GoBack">Go Back</button>
            </div>
        }
        else if (resource is not null && sentences.Any())
        {
            @* Activity Timer (daily plan mode) *@
            @if (fromPlan)
            {
                <ActivityTimer IsActive="true" TargetMinutes="targetMinutes" />
            }

            @* Audio generation progress banner *@
            @if (isGeneratingAudio)
            {
                <div class="audio-gen-banner d-flex align-items-center gap-3 mb-3">
                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                    <div class="flex-grow-1">
                        <div class="ss-body2 mb-1">@audioGenStatus</div>
                        @if (audioGenProgress > 0)
                        {
                            <div class="progress" style="height: 4px;">
                                <div class="progress-bar" style="width: @((audioGenProgress * 100).ToString("F0", System.Globalization.CultureInfo.InvariantCulture))%"></div>
                            </div>
                        }
                    </div>
                </div>
            }

            @* Reading passage — no card wrapper, sits on page background *@
            <div class="interactive-text-wrapper" style="font-size: @(fontSize)px;">
                <InteractiveText
                    Sentences="@sentences"
                    VocabularyWords="@vocabularyWords"
                    SelectedSentenceIndex="@currentSentenceIndex"
                    OnWordClicked="HandleWordClicked"
                    OnVocabularyWordClicked="HandleVocabularyWordClicked"
                    OnSentenceClicked="HandleSentenceClicked"
                    OnSentenceDoubleClicked="HandleSentenceDoubleClicked" />
            </div>
        }
        else
        {
            <div class="text-center p-5">
                <p class="ss-body1 text-secondary-ss">No reading content available.</p>
                <button class="btn btn-ss-secondary mt-3" @onclick="GoBack">Go Back</button>
            </div>
        }
    </div>

    @* Word lookup offcanvas (bottom) *@
    @if (showWordPanel)
    {
        <div class="offcanvas offcanvas-bottom show" tabindex="-1"
             style="height: auto; max-height: 45vh; border-radius: var(--bs-border-radius-xl) var(--bs-border-radius-xl) 0 0;">
            <div class="offcanvas-header pb-1">
                <h4 class="ss-title2 mb-0" style="color: var(--bs-primary);">@selectedWord</h4>
                <button type="button" class="btn-close" @onclick="CloseWordPanel"></button>
            </div>
            <div class="offcanvas-body pt-1">
                @if (isTranslating)
                {
                    <div class="d-flex align-items-center gap-2">
                        <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                        <span class="ss-body2 text-secondary-ss">Looking up definition...</span>
                    </div>
                }
                else if (!string.IsNullOrEmpty(wordDefinition))
                {
                    <p class="ss-body1 mb-2">@wordDefinition</p>
                }
                @if (selectedVocabWord is not null)
                {
                    <span class="badge bg-success text-white mb-2">
                        <i class="bi bi-check-circle me-1"></i>In your vocabulary
                    </span>
                }
                else if (!isTranslating && !string.IsNullOrEmpty(wordDefinition) && wordDefinition != "(translation unavailable)")
                {
                    @if (isSavingWord)
                    {
                        <div class="d-flex align-items-center gap-2">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            <span class="ss-body2">Saving...</span>
                        </div>
                    }
                    else
                    {
                        <button class="btn btn-sm btn-ss-primary" @onclick="SaveWordToVocabulary">
                            <i class="bi bi-bookmark-plus me-1"></i> Remember This Word
                        </button>
                    }
                }
            </div>
        </div>
        <div class="offcanvas-backdrop fade show" @onclick="CloseWordPanel"></div>
    }

    @* ── Fixed footer: transport + font slider ── *@
    @if (resource is not null && sentences.Any() && (isAudioLoaded || sentences.Any()))
    {
        <div class="reading-page__footer">
            <div class="d-flex align-items-center gap-2">
                @* Prev / Play-Pause / Next *@
                <button class="btn btn-sm btn-icon" @onclick="PreviousSentence" disabled="@(!isAudioLoaded)">
                    <i class="bi bi-skip-backward-fill"></i>
                </button>
                <button class="btn btn-sm btn-ss-primary" @onclick="TogglePlayback" disabled="@(!isAudioLoaded && !isGeneratingAudio)">
                    @if (isAudioPlaying) { <i class="bi bi-pause-fill"></i> } else { <i class="bi bi-play-fill"></i> }
                </button>
                <button class="btn btn-sm btn-icon" @onclick="NextSentence" disabled="@(!isAudioLoaded)">
                    <i class="bi bi-skip-forward-fill"></i>
                </button>

                @* Sentence counter *@
                <span class="ss-caption1 text-secondary-ss text-nowrap">
                    @if (currentSentenceIndex >= 0)
                    {
                        @($"{currentSentenceIndex + 1} / {sentences.Count}")
                    }
                    else
                    {
                        @($"— / {sentences.Count}")
                    }
                </span>

                @* Time display *@
                @if (isAudioLoaded)
                {
                    <span class="ss-caption1 text-secondary-ss ms-auto text-nowrap">
                        @FormatTime(currentAudioTime) / @FormatTime(audioDuration)
                    </span>
                }
                else
                {
                    <span class="ms-auto"></span>
                }

                @* Speed selector *@
                <select class="form-select form-select-sm" style="width: 72px;"
                        value="@playbackSpeed" @onchange="OnSpeedChanged">
                    <option value="0.5">0.5×</option>
                    <option value="0.75">0.75×</option>
                    <option value="1">1.0×</option>
                    <option value="1.25">1.25×</option>
                    <option value="1.5">1.5×</option>
                    <option value="2">2.0×</option>
                </select>

                @* Font size slider *@
                <span class="d-none d-md-inline-flex align-items-center gap-1 ms-2 border-start ps-2" style="border-color: var(--bs-border-color) !important;">
                    <i class="bi bi-fonts ss-caption1 text-secondary-ss"></i>
                    <input type="range" class="form-range" style="width: 64px;"
                           min="14" max="40" step="2" value="@fontSize"
                           @oninput="OnFontSizeChanged" />
                </span>
            </div>
        </div>
    }
</div>

@code {
    [SupplyParameterFromQuery(Name = "resourceId")]
    public int? ResourceIdParam { get; set; }

    [SupplyParameterFromQuery(Name = "fromPlan")]
    public bool FromPlanParam { get; set; }

    [SupplyParameterFromQuery(Name = "targetMinutes")]
    public int? TargetMinutesParam { get; set; }

    [Inject] private LearningResourceRepository ResourceRepo { get; set; } = default!;
    [Inject] private ElevenLabsSpeechService SpeechService { get; set; } = default!;
    [Inject] private TranslationService TranslationSvc { get; set; } = default!;
    [Inject] private UserActivityRepository ActivityRepo { get; set; } = default!;
    [Inject] private NavigationManager NavManager { get; set; } = default!;
    [Inject] private ToastService Toast { get; set; } = default!;
    [Inject] private ILogger<Reading> Logger { get; set; } = default!;
    [Inject] private ILogger<TimestampedAudioManager> AudioManagerLogger { get; set; } = default!;
    [Inject] private ILogger<SentenceTimingCalculator> TimingCalcLogger { get; set; } = default!;
    [Inject] private IActivityTimerService TimerService { get; set; } = default!;
    [Inject] private IJSRuntime JS { get; set; } = default!;
    [Inject] private SentenceStudio.Abstractions.IPreferencesService Preferences { get; set; } = default!;

    // Content state
    private bool isBusy;
    private bool fromPlan;
    private int targetMinutes;
    private string errorMessage = "";
    private int fontSize = 20;
    private float playbackSpeed = 1.0f;
    private LearningResource? resource;
    private List<string> sentences = new();
    private List<VocabularyWord> vocabularyWords = new();

    // Audio state
    private TimestampedAudioManager? _audioManager;
    private SentenceTimingCalculator? _timingCalculator;
    private bool isGeneratingAudio;
    private string audioGenStatus = "";
    private double audioGenProgress;
    private bool isAudioLoaded;
    private bool isAudioPlaying;
    private double currentAudioTime;
    private double audioDuration;
    private int currentSentenceIndex = -1;

    // Word lookup state
    private bool showWordPanel;
    private bool isTranslating;
    private bool isSavingWord;
    private string selectedWord = "";
    private string wordDefinition = "";
    private VocabularyWord? selectedVocabWord;

    // Preferences tracking
    private bool hasShownJumpHint;

    protected override async Task OnInitializedAsync()
    {
        fromPlan = FromPlanParam;
        targetMinutes = TargetMinutesParam ?? 15;

        // Load persisted preferences
        fontSize = (int)Preferences.Get("ReadingActivity_FontSize", 20.0);
        playbackSpeed = Preferences.Get("ReadingActivity_PlaybackSpeed", 1.0f);
        hasShownJumpHint = Preferences.Get("ReadingActivity_HasShownJumpHint", false);

        if (fromPlan)
        {
            TimerService.StartSession("Reading", null);
        }

        await LoadResource();
    }

    private async Task LoadResource()
    {
        if (ResourceIdParam is null or 0) return;
        isBusy = true;
        try
        {
            resource = await ResourceRepo.GetResourceAsync(ResourceIdParam.Value);
            if (resource is null)
            {
                errorMessage = "Resource not found.";
                return;
            }

            vocabularyWords = resource.Vocabulary ?? new();

            if (!string.IsNullOrEmpty(resource.Transcript))
            {
                sentences = SentenceTimingCalculator.SplitIntoSentences(resource.Transcript);
                // Remove paragraph break markers for display
                sentences = sentences.Where(s => s != "PARAGRAPH_BREAK").ToList();
            }
            else
            {
                errorMessage = "Resource has no transcript.";
                return;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load reading resource");
            errorMessage = $"Error loading resource: {ex.Message}";
        }
        finally
        {
            isBusy = false;
        }

        // Start audio generation in background (non-blocking)
        _ = InitializeAudioAsync();
    }

    private async Task InitializeAudioAsync()
    {
        if (resource?.Transcript is null) return;

        isGeneratingAudio = true;
        audioGenStatus = "Initializing audio...";
        audioGenProgress = 0.1;
        await InvokeAsync(StateHasChanged);

        try
        {
            _timingCalculator = new SentenceTimingCalculator(TimingCalcLogger);
            _audioManager = new TimestampedAudioManager(_timingCalculator, AudioManagerLogger);

            audioGenStatus = "Generating timestamped audio...";
            audioGenProgress = 0.3;
            await InvokeAsync(StateHasChanged);

            var result = await SpeechService.GenerateTimestampedAudioAsync(resource);

            if (result is not null)
            {
                audioGenStatus = "Processing timestamps...";
                audioGenProgress = 0.7;
                await InvokeAsync(StateHasChanged);

                var timestampedAudio = new TimestampedAudio
                {
                    AudioData = result.AudioData.ToArray(),
                    Characters = result.Characters,
                    FullTranscript = resource.Transcript,
                    Duration = result.Duration.TotalSeconds
                };

                audioGenStatus = "Loading audio...";
                audioGenProgress = 0.9;
                await InvokeAsync(StateHasChanged);

                await _audioManager.LoadAudioAsync(timestampedAudio);
                _audioManager.SentenceChanged += OnSentenceChanged;
                _audioManager.ProgressUpdated += OnProgressUpdated;
                _audioManager.PlaybackEnded += OnPlaybackEnded;

                // Use audio manager's sentence list (cleaned of PARAGRAPH_BREAK)
                var audioSentences = _audioManager.GetSentences()
                    .Where(s => s != "PARAGRAPH_BREAK").ToList();
                if (audioSentences.Any())
                {
                    sentences = audioSentences;
                }

                audioDuration = timestampedAudio.Duration;
                isAudioLoaded = true;

                Logger.LogInformation("Audio loaded: {Duration:F1}s, {SentenceCount} sentences",
                    audioDuration, sentences.Count);
            }
            else
            {
                Logger.LogWarning("Failed to generate timestamped audio");
                audioGenStatus = "Audio generation failed — reading without audio.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error initializing audio");
            audioGenStatus = $"Audio error: {ex.Message}";
        }
        finally
        {
            isGeneratingAudio = false;
            audioGenProgress = 0;
            await InvokeAsync(StateHasChanged);
        }
    }

    // ── Audio event handlers (fire on background threads) ──

    private void OnSentenceChanged(object? sender, int sentenceIndex)
    {
        if (currentSentenceIndex != sentenceIndex)
        {
            currentSentenceIndex = sentenceIndex;
            _ = InvokeAsync(async () =>
            {
                StateHasChanged();
                // Auto-scroll current sentence into view
                await Task.Yield(); // let DOM update
                await JS.InvokeVoidAsync("eval",
                    "document.querySelector('.sentence--selected')?.scrollIntoView({behavior:'smooth',block:'center'})");
            });
        }
    }

    private void OnProgressUpdated(object? sender, double time)
    {
        currentAudioTime = time;
        _ = InvokeAsync(StateHasChanged);
    }

    private void OnPlaybackEnded(object? sender, EventArgs e)
    {
        isAudioPlaying = false;
        currentSentenceIndex = -1;
        _ = InvokeAsync(StateHasChanged);
    }

    // ── Audio controls ──

    private async Task TogglePlayback()
    {
        if (isGeneratingAudio)
        {
            Toast.ShowError("Audio is still loading...");
            return;
        }
        if (!isAudioLoaded || _audioManager is null)
        {
            Toast.ShowError("No audio available.");
            return;
        }

        if (isAudioPlaying)
        {
            _audioManager.Pause();
            isAudioPlaying = false;
        }
        else
        {
            var startIndex = currentSentenceIndex >= 0 ? currentSentenceIndex : 0;
            await _audioManager.PlayFromSentenceAsync(startIndex);
            isAudioPlaying = true;
            currentSentenceIndex = startIndex;
        }
    }

    private async Task PreviousSentence()
    {
        if (_audioManager is null || !isAudioLoaded) return;
        if (currentSentenceIndex > 0)
        {
            currentSentenceIndex--;
            if (isAudioPlaying)
                await _audioManager.PreviousSentenceAsync();
        }
    }

    private async Task NextSentence()
    {
        if (_audioManager is null || !isAudioLoaded) return;
        if (currentSentenceIndex < sentences.Count - 1)
        {
            currentSentenceIndex++;
            if (isAudioPlaying)
                await _audioManager.NextSentenceAsync();
        }
    }

    private void OnSpeedChanged(ChangeEventArgs e)
    {
        if (float.TryParse(e.Value?.ToString(), System.Globalization.NumberStyles.Float,
            System.Globalization.CultureInfo.InvariantCulture, out var speed))
        {
            playbackSpeed = speed;
            Preferences.Set("ReadingActivity_PlaybackSpeed", playbackSpeed);
        }
    }

    private void OnFontSizeChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var size))
        {
            fontSize = size;
            Preferences.Set("ReadingActivity_FontSize", (double)fontSize);
        }
    }

    // ── Word interaction ──

    private async Task HandleWordClicked(string word)
    {
        var cleanWord = word.Trim().TrimEnd('.', ',', '!', '?', ':', ';', '"', '\'');
        selectedWord = cleanWord;
        selectedVocabWord = null;
        wordDefinition = "";
        showWordPanel = true;
        isSavingWord = false;

        // Check local vocabulary first
        var localWord = vocabularyWords?.FirstOrDefault(v =>
            v.TargetLanguageTerm?.Equals(cleanWord, StringComparison.OrdinalIgnoreCase) == true);

        if (localWord is not null && !string.IsNullOrEmpty(localWord.NativeLanguageTerm))
        {
            selectedVocabWord = localWord;
            wordDefinition = localWord.NativeLanguageTerm;
            return;
        }

        // AI translation with sentence context
        isTranslating = true;
        StateHasChanged();

        try
        {
            string? context = currentSentenceIndex >= 0 && currentSentenceIndex < sentences.Count
                ? sentences[currentSentenceIndex] : null;

            wordDefinition = await TranslationSvc.TranslateAsync(cleanWord, context);

            if (string.IsNullOrEmpty(wordDefinition))
                wordDefinition = "(translation unavailable)";

            // Record lookup activity
            await ActivityRepo.SaveAsync(new UserActivity
            {
                Activity = Activity.Reading.ToString(),
                Input = $"Dictionary lookup: {cleanWord}",
                Accuracy = 100,
                Fluency = 100,
                CreatedAt = DateTime.UtcNow,
                UpdatedAt = DateTime.UtcNow
            });
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Translation failed for: {Word}", cleanWord);
            wordDefinition = "(translation unavailable)";
        }
        finally
        {
            isTranslating = false;
        }
    }

    private Task HandleVocabularyWordClicked(VocabularyWord vw)
    {
        selectedWord = vw.TargetLanguageTerm ?? "";
        selectedVocabWord = vw;
        wordDefinition = vw.NativeLanguageTerm ?? "";
        showWordPanel = true;
        isSavingWord = false;
        return Task.CompletedTask;
    }

    private Task HandleSentenceClicked(int index)
    {
        currentSentenceIndex = index == currentSentenceIndex ? -1 : index;
        return Task.CompletedTask;
    }

    private async Task HandleSentenceDoubleClicked(int sentenceIndex)
    {
        if (_audioManager is null || !isAudioLoaded) return;

        if (!hasShownJumpHint)
        {
            Toast.ShowSuccess("Double-click a sentence to jump to it!");
            hasShownJumpHint = true;
            Preferences.Set("ReadingActivity_HasShownJumpHint", true);
        }

        currentSentenceIndex = sentenceIndex;
        await _audioManager.PlayFromSentenceAsync(sentenceIndex);
        isAudioPlaying = true;
    }

    private async Task SaveWordToVocabulary()
    {
        if (string.IsNullOrEmpty(selectedWord) || string.IsNullOrEmpty(wordDefinition)) return;

        isSavingWord = true;
        StateHasChanged();

        try
        {
            var newWord = new VocabularyWord
            {
                TargetLanguageTerm = selectedWord,
                NativeLanguageTerm = wordDefinition,
                CreatedAt = DateTime.UtcNow,
                UpdatedAt = DateTime.UtcNow
            };

            var result = await ResourceRepo.SaveWordAsync(newWord);
            if (result > 0)
            {
                // Associate with current resource
                if (resource?.Id > 0)
                {
                    await ResourceRepo.AddVocabularyToResourceAsync(resource.Id, newWord.Id);
                    vocabularyWords ??= new();
                    vocabularyWords.Add(newWord);
                }

                selectedVocabWord = newWord;
                Toast.ShowSuccess($"'{selectedWord}' saved to vocabulary!");

                await ActivityRepo.SaveAsync(new UserActivity
                {
                    Activity = Activity.Reading.ToString(),
                    Input = $"Added vocabulary: {selectedWord}",
                    Accuracy = 100,
                    Fluency = 100,
                    CreatedAt = DateTime.UtcNow,
                    UpdatedAt = DateTime.UtcNow
                });
            }
            else
            {
                Toast.ShowError("Could not save word.");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to save word: {Word}", selectedWord);
            Toast.ShowError("Error saving word.");
        }
        finally
        {
            isSavingWord = false;
        }
    }

    private void CloseWordPanel()
    {
        showWordPanel = false;
        selectedWord = "";
        wordDefinition = "";
        selectedVocabWord = null;
        isSavingWord = false;
    }

    // ── Navigation ──

    private async Task GoBack()
    {
        // Stop audio
        if (_audioManager is not null)
        {
            _audioManager.Stop();
            isAudioPlaying = false;
        }

        // Pause timer
        if (fromPlan && TimerService.IsActive)
        {
            TimerService.Pause();
        }

        // Record reading session
        if (resource is not null)
        {
            await ActivityRepo.SaveAsync(new UserActivity
            {
                Activity = Activity.Reading.ToString(),
                Input = $"Reading session: {resource.Title}",
                Accuracy = 100,
                Fluency = 100,
                CreatedAt = DateTime.UtcNow,
                UpdatedAt = DateTime.UtcNow
            });
        }

        NavManager.NavigateTo("/");
    }

    // ── Utilities ──

    private static string FormatTime(double seconds)
    {
        if (seconds < 0 || double.IsNaN(seconds)) seconds = 0;
        var ts = TimeSpan.FromSeconds(seconds);
        return ts.TotalHours >= 1 ? ts.ToString(@"h\:mm\:ss") : ts.ToString(@"m\:ss");
    }

    public void Dispose()
    {
        if (_audioManager is not null)
        {
            _audioManager.SentenceChanged -= OnSentenceChanged;
            _audioManager.ProgressUpdated -= OnProgressUpdated;
            _audioManager.PlaybackEnded -= OnPlaybackEnded;
            _audioManager.Dispose();
        }
    }
}
