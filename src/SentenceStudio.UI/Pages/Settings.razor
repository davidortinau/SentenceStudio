@page "/settings"
@inject ThemeService ThemeService
@inject IJSRuntime JS

<PageHeader Title="Settings" />

@* Appearance *@
<div class="card card-ss p-4 mb-3">
    <h5 class="ss-title3 mb-3">Appearance</h5>

    <div class="mb-3">
        <label class="form-label ss-body2 text-secondary-ss">Theme</label>
        <div class="d-flex flex-wrap gap-2">
            @foreach (var theme in ThemeService.AvailableThemes)
            {
                var (primary, accent) = ThemeService.GetThemeColors(theme, ThemeService.CurrentMode);
                var isSelected = ThemeService.CurrentTheme == theme;

                <button type="button" 
                        class="theme-swatch @(isSelected ? "selected" : "")"
                        @onclick="() => OnThemeSelected(theme)"
                        title="@ThemeService.GetThemeDisplayName(theme)">
                    <div class="theme-swatch-colors">
                        <div class="color-primary" style="background-color: @primary"></div>
                        <div class="color-accent" style="background-color: @accent"></div>
                    </div>
                    <div class="theme-swatch-label">@ThemeService.GetThemeDisplayName(theme)</div>
                </button>
            }
        </div>
    </div>

    <div class="mb-3">
        <label class="form-label ss-body2 text-secondary-ss">Mode</label>
        <div class="btn-group w-100" role="group">
            <input type="radio" class="btn-check" name="themeMode" id="modeLight" 
                   checked="@(!ThemeService.IsDarkMode)" 
                   @onchange="@(() => OnModeChanged("light"))" />
            <label class="btn btn-outline-secondary" for="modeLight">
                <i class="bi bi-sun me-1"></i> Light
            </label>
            
            <input type="radio" class="btn-check" name="themeMode" id="modeDark" 
                   checked="@ThemeService.IsDarkMode" 
                   @onchange="@(() => OnModeChanged("dark"))" />
            <label class="btn btn-outline-secondary" for="modeDark">
                <i class="bi bi-moon me-1"></i> Dark
            </label>
        </div>
    </div>

    <div class="mb-3">
        <label class="form-label ss-body2 text-secondary-ss">
            Text Size: @((int)(fontScale * 100))%
        </label>
        <input type="range" class="form-range" min="0.85" max="1.5" step="0.05"
               value="@fontScale" @oninput="OnFontScaleInput" />
        <div class="d-flex justify-content-between">
            <small class="text-secondary-ss">85%</small>
            <small class="text-secondary-ss">150%</small>
        </div>
    </div>
</div>

@* Voice & Quiz Settings *@
<div class="card card-ss p-4 mb-3">
    <h5 class="ss-title3 mb-3">Voice & Quiz</h5>

    <div class="mb-3">
        <label class="form-label ss-body2 text-secondary-ss">Language</label>
        <select class="form-select form-control-ss" @bind="selectedLanguage" @bind:after="OnLanguageChanged">
            <option value="Korean">Korean</option>
            <option value="English">English</option>
            <option value="French">French</option>
            <option value="German">German</option>
            <option value="Spanish">Spanish</option>
        </select>
    </div>

    <div class="mb-3">
        <label class="form-label ss-body2 text-secondary-ss">Voice</label>
        @if (isLoadingVoices)
        {
            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
        }
        else
        {
            <select class="form-select form-control-ss" @bind="selectedVoiceId">
                @foreach (var voice in availableVoices)
                {
                    <option value="@voice.Id">@voice.Name</option>
                }
            </select>
        }
    </div>

    <div class="mb-3">
        <label class="form-label ss-body2 text-secondary-ss">Quiz Direction</label>
        <div class="btn-group w-100" role="group">
            <input type="radio" class="btn-check" name="quizDir" id="dirForward" value="Forward" @onchange="@(() => quizDirection = "Forward")" checked="@(quizDirection == "Forward")" />
            <label class="btn btn-outline-secondary" for="dirForward">Forward</label>
            <input type="radio" class="btn-check" name="quizDir" id="dirReverse" value="Reverse" @onchange="@(() => quizDirection = "Reverse")" checked="@(quizDirection == "Reverse")" />
            <label class="btn btn-outline-secondary" for="dirReverse">Reverse</label>
            <input type="radio" class="btn-check" name="quizDir" id="dirMixed" value="Mixed" @onchange="@(() => quizDirection = "Mixed")" checked="@(quizDirection == "Mixed")" />
            <label class="btn btn-outline-secondary" for="dirMixed">Mixed</label>
        </div>
    </div>

    <div class="form-check form-switch mb-2">
        <input class="form-check-input" type="checkbox" id="autoplay" @bind="quizAutoplay" />
        <label class="form-check-label ss-body2" for="autoplay">Autoplay Audio</label>
    </div>

    <div class="form-check form-switch mb-2">
        <input class="form-check-input" type="checkbox" id="showMnemonic" @bind="quizShowMnemonic" />
        <label class="form-check-label ss-body2" for="showMnemonic">Show Mnemonics</label>
    </div>

    <div class="mb-3">
        <label class="form-label ss-body2 text-secondary-ss">
            Auto-Advance Duration: @quizAutoAdvanceDuration s
        </label>
        <input type="range" class="form-range" min="1" max="10" step="0.5"
               @bind="quizAutoAdvanceDuration" @bind:event="oninput" />
    </div>

    <button class="btn btn-ss-primary" @onclick="SavePreferences">Save Preferences</button>
</div>

@* Data Management *@
<div class="card card-ss p-4 mb-3">
    <h5 class="ss-title3 mb-3">Data Management</h5>

    <button class="btn btn-ss-secondary w-100" @onclick="ExportData" disabled="@isExporting">
        @if (isExporting)
        {
            <span class="spinner-border spinner-border-sm me-2"></span>
        }
        Export Data
    </button>
</div>

@* Database Migrations *@
<div class="card card-ss p-4 mb-3">
    <h5 class="ss-title3 mb-3">Database Migrations</h5>

    @if (streakMigrationComplete)
    {
        <div class="alert alert-success ss-body2">Streak migration complete</div>
    }
    else
    {
        <button class="btn btn-ss-secondary w-100" @onclick="RunStreakMigration" disabled="@isMigrating">
            @if (isMigrating)
            {
                <span class="spinner-border spinner-border-sm me-2"></span>
            }
            Run Streak Migration
        </button>
    }

    @if (!string.IsNullOrEmpty(statusMessage))
    {
        <p class="ss-caption1 mt-2">@statusMessage</p>
    }
</div>

@* About *@
<div class="card card-ss p-4">
    <h5 class="ss-title3 mb-2">About</h5>
    <p class="ss-caption1 text-muted-ss">SentenceStudio v1.0</p>
</div>

@code {
    [Inject] private IVocabularyProgressService VocabProgressService { get; set; }
    [Inject] private DataExportService ExportService { get; set; }
    [Inject] private SentenceStudio.Services.Speech.IVoiceDiscoveryService VoiceDiscovery { get; set; }
    [Inject] private SpeechVoicePreferences VoicePrefs { get; set; }
    [Inject] private VocabularyQuizPreferences QuizPrefs { get; set; }
    [Inject] private ToastService Toast { get; set; }

    private IJSObjectReference? jsModule;

    private string selectedLanguage = "Korean";
    private string selectedVoiceId = "";
    private List<VoiceInfo> availableVoices = new();
    private bool isLoadingVoices;
    private string quizDirection = "Forward";
    private bool quizAutoplay;
    private bool quizShowMnemonic;
    private double quizAutoAdvanceDuration = 3.0;
    private double fontScale = 1.0;
    private bool isExporting;
    private bool isMigrating;
    private bool streakMigrationComplete;
    private string statusMessage = "";

    private record VoiceInfo(string Id, string Name);

    protected override async Task OnInitializedAsync()
    {
        jsModule = await JS.InvokeAsync<IJSObjectReference>("import", "./_content/SentenceStudio.UI/js/app.js");
        fontScale = ThemeService.FontScale;
        LoadPreferences();
        await LoadVoicesAsync();
    }

    private async Task OnThemeSelected(string theme)
    {
        ThemeService.SetTheme(theme);
        await ApplyThemeToDOM();
        StateHasChanged();
    }

    private async Task OnModeChanged(string mode)
    {
        ThemeService.SetMode(mode);
        await ApplyThemeToDOM();
        StateHasChanged();
    }

    private async Task OnFontScaleInput(ChangeEventArgs e)
    {
        if (double.TryParse(e.Value?.ToString(), System.Globalization.NumberStyles.Any, 
            System.Globalization.CultureInfo.InvariantCulture, out var scale))
        {
            fontScale = scale;
            ThemeService.SetFontScale(fontScale);
            if (jsModule != null)
                await jsModule.InvokeVoidAsync("setFontScale", fontScale);
        }
    }

    private async Task ApplyThemeToDOM()
    {
        if (jsModule != null)
        {
            await jsModule.InvokeVoidAsync("applyTheme", ThemeService.CurrentTheme, ThemeService.CurrentMode);
        }
    }

    private void LoadPreferences()
    {
        quizDirection = QuizPrefs.DisplayDirection;
        quizAutoplay = QuizPrefs.AutoPlayVocabAudio;
        quizShowMnemonic = QuizPrefs.ShowMnemonicImage;
        quizAutoAdvanceDuration = QuizPrefs.AutoAdvanceDuration / 1000.0;
        selectedLanguage = "Korean";
        selectedVoiceId = VoicePrefs.GetVoiceForLanguage(selectedLanguage) ?? "";
    }

    private async Task LoadVoicesAsync()
    {
        isLoadingVoices = true;
        try
        {
            var voices = await VoiceDiscovery.GetVoicesForLanguageAsync(selectedLanguage);
            availableVoices = voices.Select(v => new VoiceInfo(v.VoiceId, v.Name)).ToList();
            if (!availableVoices.Any(v => v.Id == selectedVoiceId) && availableVoices.Any())
                selectedVoiceId = availableVoices.First().Id;
        }
        catch { }
        finally
        {
            isLoadingVoices = false;
        }
    }

    private async Task OnLanguageChanged()
    {
        await LoadVoicesAsync();
    }

    private void SavePreferences()
    {
        QuizPrefs.DisplayDirection = quizDirection;
        QuizPrefs.AutoPlayVocabAudio = quizAutoplay;
        QuizPrefs.ShowMnemonicImage = quizShowMnemonic;
        QuizPrefs.AutoAdvanceDuration = (int)(quizAutoAdvanceDuration * 1000);
        VoicePrefs.SetVoiceForLanguage(selectedLanguage, selectedVoiceId);
        Toast.ShowSuccess("Preferences saved");
    }

    private async Task ExportData()
    {
        isExporting = true;
        try
        {
            await ExportService.ExportAllDataAsZipAsync();
            Toast.ShowSuccess("Data exported successfully");
        }
        catch (Exception ex)
        {
            Toast.ShowError($"Export failed: {ex.Message}");
        }
        finally
        {
            isExporting = false;
        }
    }

    private async Task RunStreakMigration()
    {
        isMigrating = true;
        statusMessage = "Running migration...";
        try
        {
            await VocabProgressService.MigrateToStreakBasedScoringAsync();
            streakMigrationComplete = true;
            statusMessage = "Migration completed successfully";
            Toast.ShowSuccess("Streak migration complete");
        }
        catch (Exception ex)
        {
            statusMessage = $"Migration failed: {ex.Message}";
            Toast.ShowError(statusMessage);
        }
        finally
        {
            isMigrating = false;
        }
    }
}
